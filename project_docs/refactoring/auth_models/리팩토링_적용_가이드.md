# 사용자 모델 리팩토링 적용 가이드

이 문서는 온라인 팝스(PAPS) 교육 플랫폼의 사용자 모델을 리팩토링하기 위한 단계별 가이드입니다. 기존 `User` 모델을 `BaseUser`, `Teacher`, `Student`, `Admin` 모델로 세분화하여 확장성과 유지보수성을 개선합니다.

## 리팩토링 목표

1. 사용자 모델을 역할별로 세분화하여 관심사 분리
2. 역할 기반 권한 관리 개선
3. 코드 유지보수성 향상
4. 확장성 개선
5. 테스트 용이성 향상

## 리팩토링 적용 단계

### 1단계: 도메인 계층 엔티티 정의

1. **`lib/features/auth/domain/entities/base_user.dart` 생성:**
   - 모든 사용자 유형이 공유하는 기본 정보를 포함
   - `UserRole` enum을 이 파일로 이동

2. **`lib/features/auth/domain/entities/teacher.dart` 생성:**
   - 교사 관련 세부 정보를 포함
   - `BaseUser`를 컴포지션으로 포함

3. **`lib/features/auth/domain/entities/student.dart` 수정:**
   - 기존 `Student` 엔티티를 수정하여 `BaseUser`를 컴포지션으로 포함
   - 학생 관련 세부 정보만 유지

4. **`lib/features/auth/domain/entities/admin.dart` 생성:**
   - 관리자 관련 세부 정보를 포함
   - `BaseUser`를 컴포지션으로 포함

### 2단계: 데이터 계층 모델 정의

1. **`lib/features/auth/data/models/base_user_model.dart` 생성:**
   - `BaseUser` 엔티티의 데이터 모델 구현
   - Firestore 데이터 변환 메서드 구현 (fromJson, toJson)

2. **`lib/features/auth/data/models/teacher_model.dart` 생성:**
   - `Teacher` 엔티티의 데이터 모델 구현
   - Firestore 변환 메서드 구현 (fromFirestore, toFirestore)

3. **`lib/features/auth/data/models/student_model.dart` 수정:**
   - 기존 `StudentModel`을 수정하여 `BaseUserModel`을 컴포지션으로 포함
   - Firestore 변환 메서드 수정

4. **`lib/features/auth/data/models/admin_model.dart` 생성:**
   - `Admin` 엔티티의 데이터 모델 구현
   - Firestore 변환 메서드 구현

### 3단계: 데이터 소스 수정

1. **`lib/features/auth/data/datasources/auth_remote_data_source.dart` 수정:**
   - `getCurrentUser()`가 `BaseUserModel`을 반환하도록 수정
   - `getCurrentUserWithDetails()` 메서드 추가
   - 로그인/회원가입 메서드 수정

2. **`lib/features/auth/data/datasources/student_remote_data_source.dart` 수정:**
   - 학생 CRUD 메서드가 새로운 `StudentModel`을 사용하도록 수정
   - `BaseUserModel` 생성 로직 추가

### 4단계: 레포지토리 수정

1. **`lib/features/auth/domain/repositories/auth_repository.dart` 수정:**
   - 리턴 타입을 새로운 엔티티에 맞게 수정
   - `getCurrentUserWithDetails()` 메서드 추가

2. **`lib/features/auth/data/repositories/auth_repository_impl.dart` 수정:**
   - 인터페이스 구현 업데이트
   - 데이터 소스에서 받은 모델을 적절한 엔티티로 변환

3. **`lib/features/auth/domain/repositories/student_repository.dart` 수정:**
   - 새로운 `Student` 엔티티를 사용하도록 수정

4. **`lib/features/auth/data/repositories/student_repository_impl.dart` 수정:**
   - 새로운 `StudentModel`을 사용하도록 수정

### 5단계: 유스케이스 수정

1. **인증 관련 유스케이스:**
   - `GetCurrentUser` - 리턴 타입을 `BaseUser?`로 수정
   - `GetCurrentUserWithDetails` - 새로 추가
   - `SignInWithEmailPassword` - 리턴 타입을 `BaseUser`로 수정
   - `SignUpTeacher` - 리턴 타입을 `Teacher`로 수정
   - `SignInStudent` - 리턴 타입을 `BaseUser`로 수정
   - `SignInAdmin` - 새로 추가, 리턴 타입은 `Admin`
   - `ApproveTeacher` - 수정

2. **학생 관련 유스케이스:**
   - `GetStudentsByTeacher` - 수정
   - `UploadStudents` - 수정
   - `ChangeStudentPassword` - 수정
   - `UpdateStudentGender` - 수정
   - `ResetStudentPassword` - 수정

### 6단계: 프레젠테이션 계층 수정

1. **Cubit/State 수정:**
   - `AuthCubit`과 `AuthState` 수정
   - `StudentCubit`과 `StudentState` 수정
   - 관리자 관련 Cubit 필요시 추가

2. **UI 화면 수정:**
   - 각 화면에서 사용자 정보를 표시하는 부분 수정
   - 역할별 권한 체크 로직 수정

### 7단계: Firestore 데이터베이스 구조 변경

1. `users` 컬렉션: 기본 사용자 정보만 저장
2. `teachers_details` 컬렉션: 교사 세부 정보 저장
3. `students_details` 컬렉션: 학생 세부 정보 저장
4. `admins_details` 컬렉션: 관리자 세부 정보 저장

### 8단계: Cloud Functions 수정 (필요시)

1. 기존 함수들이 새로운 컬렉션 구조를 사용하도록 수정
2. 권한 체크 로직 수정

## 구현 세부 계획

### 일정 계획

1. **준비 및 설계 (1일):**
   - 리팩토링 계획 검토
   - 새 모델 구조 설계 확정
   - 테스트 계획 수립

2. **도메인 및 데이터 계층 구현 (2일):**
   - 엔티티와 모델 구현
   - 데이터 소스 및 레포지토리 구현
   - 단위 테스트 작성

3. **유스케이스 및 프레젠테이션 계층 구현 (2일):**
   - 유스케이스 수정
   - Cubit 및 State 수정
   - UI 화면 수정
   - 통합 테스트 작성

4. **데이터베이스 마이그레이션 및 동기화 (1일):**
   - Firestore 구조 변경
   - Cloud Functions 수정
   - 데이터 일관성 확인

5. **테스트 및 디버깅 (2일):**
   - 전체 기능 테스트
   - 단위/통합 테스트 실행
   - 디버깅 및 문제 해결

6. **최종 검토 및 배포 (1일):**
   - 성능 확인
   - 코드 리뷰
   - 배포 준비 및 실행

### 주의사항

1. **중단 없는 서비스 제공:**
   - 기존 기능이 리팩토링 중에도 계속 작동하도록 점진적 배포
   - 핵심 기능부터 순차적으로 리팩토링

2. **역호환성:**
   - 기존 데이터 구조와의 호환성 유지
   - 레거시 코드와의 충돌 방지

3. **에러 처리:**
   - 각 계층에서 명확한 에러 메시지 제공
   - 로깅 강화

4. **테스트 범위:**
   - 핵심 기능에 대한 단위 테스트 필수
   - 통합 테스트로 전체 플로우 검증

## 리팩토링 체크리스트

- [ ] 도메인 계층 엔티티 구현
  - [ ] BaseUser 엔티티
  - [ ] Teacher 엔티티
  - [ ] Student 엔티티 수정
  - [ ] Admin 엔티티

- [ ] 데이터 계층 모델 구현
  - [ ] BaseUserModel
  - [ ] TeacherModel
  - [ ] StudentModel 수정
  - [ ] AdminModel

- [ ] 데이터 소스 및 레포지토리 수정
  - [ ] AuthRemoteDataSource
  - [ ] StudentRemoteDataSource
  - [ ] AuthRepository 인터페이스
  - [ ] AuthRepositoryImpl
  - [ ] StudentRepository 인터페이스
  - [ ] StudentRepositoryImpl

- [ ] 유스케이스 수정
  - [ ] GetCurrentUser
  - [ ] GetCurrentUserWithDetails
  - [ ] SignInWithEmailPassword
  - [ ] SignUpTeacher
  - [ ] SignInStudent
  - [ ] SignInAdmin
  - [ ] ApproveTeacher
  - [ ] 학생 관련 유스케이스들

- [ ] 프레젠테이션 계층 수정
  - [ ] AuthCubit/State
  - [ ] StudentCubit/State
  - [ ] UI 화면들

- [ ] 데이터베이스 구조 변경
  - [ ] Firestore 컬렉션 구성
  - [ ] Cloud Functions 수정

- [ ] 테스트
  - [ ] 단위 테스트
  - [ ] 통합 테스트
  - [ ] UI 테스트

- [ ] 문서화
  - [ ] 코드 주석
  - [ ] README 업데이트
  - [ ] API 문서화

## 결론

이 리팩토링을 통해 사용자 모델 구조가 더 명확해지고, 역할별 기능과 권한 관리가 용이해집니다. 코드 유지보수성과 확장성이 크게 향상되어, 향후 새로운 기능 추가나 변경이 더 쉬워질 것입니다.

특히 교사 계정 관리, 학생 데이터 처리, 관리자 기능 등이 더 명확히 분리되어 각 역할에 맞는 기능 개발이 용이해질 것입니다. 또한 클린 아키텍처의 원칙을 더 철저히 따를 수 있게 되어, 도메인 로직의 순수성을 보장하고 외부 의존성의 영향을 최소화할 수 있습니다.
